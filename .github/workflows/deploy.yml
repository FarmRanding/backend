name: ğŸš€ íŒœëœë”© ë°±ì—”ë“œ ë°°í¬

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_deploy:
    name: ğŸ—ï¸ ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: kanguk/farmranding

    steps:
      # 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Docker Buildx ì„¤ì •
      - name: ğŸ³ Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      # 3ï¸âƒ£ DockerHub ë¡œê·¸ì¸
      - name: ğŸ” DockerHub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ (ì»¤ë°‹ SHA íƒœê·¸)
      - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
        run: |
          echo "ğŸ”¨ ì»¤ë°‹ SHA íƒœê·¸ë¡œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ"
          docker buildx build --push --platform linux/amd64 \
            -t $IMAGE_NAME:${{ github.sha }} .

      # 5ï¸âƒ£ EC2 SSH í‚¤ ë³µì‚¬
      - name: ğŸ”‘ EC2 SSH í‚¤ ë³µì‚¬
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/farmranding.pem
          chmod 600 ~/.ssh/farmranding.pem

      # 6ï¸âƒ£ EC2ì— ë°°í¬ ë° ì»¨í…Œì´ë„ˆ êµì²´
      - name: ğŸš€ EC2ì— ë°°í¬ ë° ì»¨í…Œì´ë„ˆ êµì²´
        run: |
          echo "ğŸ–¥ï¸ EC2ì— ì ‘ì†í•˜ì—¬ ì»¨í…Œì´ë„ˆ êµì²´ ë° ì´ë¯¸ì§€ ì •ë¦¬"
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/farmranding.pem ubuntu@ec2-43-200-92-45.ap-northeast-2.compute.amazonaws.com << 'EOF'
            set -e

            echo "ğŸ—‘ï¸ ìµœì‹  5ê°œ ì´ë¯¸ì§€ë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ì‚­ì œ"
            docker images --format '{{.Repository}}:{{.Tag}} {{.CreatedAt}}' | \
              grep '^kanguk/farmranding:' | \
              sort -rk2 | \
              awk 'NR>5 {print \$1}' | \
              xargs -r docker rmi || true

            echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ"
            docker rm -f farmranding || true

            echo "â¬‡ï¸ ìƒˆ ì´ë¯¸ì§€ pull"
            docker pull kanguk/farmranding:${{ github.sha }}

            echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
            docker run --name farmranding --env-file /home/ubuntu/env.properties -p 8080:8080 -d kanguk/farmranding:${{ github.sha }}

            echo "âœ… ë°°í¬ ë° ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ"
          EOF

      # 7ï¸âƒ£ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      - name: ğŸ‰ ë°°í¬ ì™„ë£Œ
        run: |
          echo "ğŸ‰ íŒœëœë”© ë°±ì—”ë“œ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸŒ API ì„œë²„: http://íŒœëœë”©.net"
          echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date)"